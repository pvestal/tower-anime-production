#!/usr/bin/env python3
"""Personal Anime Generation CLI Tool"""

import argparse
import sys
from pathlib import Path

# Add the project to Python path
sys.path.append('/opt/tower-anime-production')

# Import the unified core
from anime_generation_core import anime_core

class AnimeGenerator:
    def __init__(self):
        # Use the unified core system
        self.core = anime_core

    # All core functionality delegated to anime_core

    def generate(self, character_name, pose, prompt_extra="", variations=1):
        """Main generation function using unified core"""
        print(f"ğŸ¨ Generating {variations} image(s) for {character_name}")

        # Check character exists
        if character_name not in self.core.list_characters():
            print(f"âŒ Character '{character_name}' not found")
            print(f"   Available: {self.core.list_characters()}")
            return []

        print(f"  Character: {character_name} âœ“")
        print(f"  Pose: {pose}")

        # Check pose skeleton exists
        pose_ref = self.core.get_pose_skeleton(pose)
        if not pose_ref:
            print("âŒ Could not generate pose")
            return []

        print(f"  Pose skeleton: âœ“")

        try:
            # Use core's batch generation
            results = self.core.generate_character_variations(
                character_name, pose, prompt_extra, variations
            )

            output_files = []
            for i, result in enumerate(results):
                print(f"\n  Variation {i+1}/{variations}:")
                if result["success"]:
                    print(f"  Generating... (ID: {result.get('prompt_id', 'N/A')})")
                    output_files.append(result["organized_output"])
                    print(f"    âœ… Saved: {Path(result['organized_output']).name}")
                else:
                    print(f"    âŒ Generation failed: {result.get('error', 'Unknown error')}")

            return output_files

        except Exception as e:
            print(f"âŒ Error: {e}")
            return []

    def list_characters(self):
        """List available characters"""
        return self.core.list_characters()

    def add_character(self, name, reference_image, description=""):
        """Add a new character to the library"""
        try:
            result = self.core.add_character(name, reference_image, description)
            print(f"âœ… Added character: {result['name']}")
            print(f"   Reference: {result['reference_path']}")
        except Exception as e:
            print(f"âŒ Error adding character: {e}")

def main():
    parser = argparse.ArgumentParser(description="Personal Anime Generation Tool")
    subparsers = parser.add_subparsers(dest="command", help="Commands")

    # Generate command
    gen_parser = subparsers.add_parser("generate", aliases=["gen"], help="Generate anime image")
    gen_parser.add_argument("character", help="Character name")
    gen_parser.add_argument("pose", help="Pose description")
    gen_parser.add_argument("--extra", default="", help="Extra prompt details")
    gen_parser.add_argument("--variations", "-n", type=int, default=1, help="Number of variations")

    # List command
    list_parser = subparsers.add_parser("list", aliases=["ls"], help="List characters")

    # Add command
    add_parser = subparsers.add_parser("add", help="Add new character")
    add_parser.add_argument("name", help="Character name")
    add_parser.add_argument("reference", help="Reference image path")
    add_parser.add_argument("--description", default="", help="Character description")

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        return

    generator = AnimeGenerator()

    if args.command in ["generate", "gen"]:
        results = generator.generate(args.character, args.pose, args.extra, args.variations)
        if results:
            print(f"\nğŸ‰ Generated {len(results)} images:")
            for result in results:
                print(f"   {result}")

    elif args.command in ["list", "ls"]:
        characters = generator.list_characters()
        if characters:
            print("Available characters:")
            for char in characters:
                print(f"  - {char}")
        else:
            print("No characters found. Use 'anime-gen add' to create one.")

    elif args.command == "add":
        if not Path(args.reference).exists():
            print(f"âŒ Reference image not found: {args.reference}")
            return
        generator.add_character(args.name, args.reference, args.description)

if __name__ == "__main__":
    main()