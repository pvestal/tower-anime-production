<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Production Progress Monitor</title>
    <link rel="stylesheet" href="progress_ui.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            margin: 0;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .debug-panel {
            background: #2d2d2d;
            color: #e0e0e0;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .debug-panel h4 {
            margin: 0 0 10px 0;
            color: #4CAF50;
        }

        .log-entry {
            margin-bottom: 5px;
            word-break: break-word;
        }

        .log-entry .timestamp {
            color: #888;
            margin-right: 10px;
        }

        .log-entry.info { color: #2196F3; }
        .log-entry.success { color: #4CAF50; }
        .log-entry.warning { color: #FF9800; }
        .log-entry.error { color: #F44336; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸŽ¬ Anime Production Progress Monitor</h1>
        <p>Real-time WebSocket progress tracking for anime generation jobs</p>
    </div>

    <div class="controls">
        <button id="connectBtn" class="btn btn-primary">Connect</button>
        <button id="disconnectBtn" class="btn btn-secondary">Disconnect</button>
        <button id="clearDebugBtn" class="btn btn-danger">Clear Debug</button>
        <button id="testJobBtn" class="btn btn-primary">Subscribe to Job #1</button>
    </div>

    <!-- Main progress container -->
    <div id="animeProgressContainer"></div>

    <!-- Debug panel -->
    <div class="debug-panel">
        <h4>Debug Console</h4>
        <div id="debugLog"></div>
    </div>

    <script src="websocket_progress_client.js"></script>
    <script>
        // Debug logging
        const debugLog = document.getElementById('debugLog');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `<span class="timestamp">${timestamp}</span>${message}`;
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        // Initialize progress UI with custom options
        let progressUI = null;

        function initializeProgressUI() {
            try {
                progressUI = new AnimeProgressUI('animeProgressContainer', {
                    wsUrl: 'ws://192.168.50.135:8330',
                    maxReconnectAttempts: 5,
                    reconnectDelay: 2000,

                    onConnect: () => {
                        log('Connected to anime production progress server', 'success');
                        document.getElementById('connectBtn').disabled = true;
                        document.getElementById('disconnectBtn').disabled = false;
                    },

                    onDisconnect: (event) => {
                        log(`Disconnected from server (code: ${event.code})`, 'warning');
                        document.getElementById('connectBtn').disabled = false;
                        document.getElementById('disconnectBtn').disabled = true;
                    },

                    onProgressUpdate: (job) => {
                        log(`Progress update: Job #${job.id} - ${job.status} (${job.progress}%)`, 'info');
                    },

                    onJobComplete: (job) => {
                        const status = job.status === 'completed' ? 'success' : 'error';
                        log(`Job #${job.id} ${job.status}!`, status);
                    },

                    onInitialJobs: (jobs) => {
                        log(`Received ${jobs.length} initial jobs`, 'info');
                    },

                    onError: (error) => {
                        log(`Error: ${error.message || error}`, 'error');
                    }
                });

                log('Progress UI initialized', 'success');
            } catch (error) {
                log(`Failed to initialize Progress UI: ${error.message}`, 'error');
            }
        }

        // Control buttons
        document.getElementById('connectBtn').addEventListener('click', () => {
            if (progressUI) {
                progressUI.client.connect();
            } else {
                initializeProgressUI();
            }
        });

        document.getElementById('disconnectBtn').addEventListener('click', () => {
            if (progressUI) {
                progressUI.client.disconnect();
                log('Manual disconnect requested', 'warning');
            }
        });

        document.getElementById('clearDebugBtn').addEventListener('click', () => {
            debugLog.innerHTML = '';
        });

        document.getElementById('testJobBtn').addEventListener('click', () => {
            if (progressUI && progressUI.client.isConnected) {
                progressUI.client.subscribeToJob(1);
                log('Subscribed to job #1', 'info');
            } else {
                log('Not connected to server', 'warning');
            }
        });

        // Auto-initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            log('Page loaded, initializing...', 'info');
            initializeProgressUI();
        });

        // Show stats periodically
        setInterval(() => {
            if (progressUI) {
                const stats = progressUI.client.getStats();
                if (stats.isConnected) {
                    console.log('Progress Stats:', stats);
                }
            }
        }, 10000); // Every 10 seconds
    </script>
</body>
</html>